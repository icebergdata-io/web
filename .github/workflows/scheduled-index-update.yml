name: Scheduled Case Studies Index Update

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Regenerate case studies index
        run: |
          echo "üîÑ Regenerating case studies index..."
          node scripts/regenerate-index.js

      - name: Validate sitemap XML
        run: |
          echo "üîç Validating generated sitemap XML..."
          if command -v xmllint &> /dev/null; then
            xmllint --noout public/sitemap.xml
            echo "‚úÖ Sitemap XML is valid"
          else
            echo "‚ö†Ô∏è xmllint not available, skipping XML validation"
          fi

      - name: Check for changes (index and sitemap files)
        id: verify-changed-files
        shell: bash
        run: |
          set -euo pipefail
          INDEX_FILE="public/articles/cases/index.json"
          SITEMAP_FILE="public/sitemap.xml"

          # Check both files for changes
          git add -N "$INDEX_FILE" "$SITEMAP_FILE" || true

          INDEX_CHANGED=false
          SITEMAP_CHANGED=false

          if ! git diff --quiet --exit-code -- "$INDEX_FILE"; then
            INDEX_CHANGED=true
            echo 'üìù Changes detected in index file'
          fi

          if ! git diff --quiet --exit-code -- "$SITEMAP_FILE"; then
            SITEMAP_CHANGED=true
            echo 'üìù Changes detected in sitemap file'
          fi

          if [[ "$INDEX_CHANGED" == "true" || "$SITEMAP_CHANGED" == "true" ]]; then
            echo 'changed=true' >> "$GITHUB_OUTPUT"
            echo '‚úÖ Changes detected in index or sitemap files'
          else
            echo 'changed=false' >> "$GITHUB_OUTPUT"
            echo '‚úÖ No changes to index or sitemap files'
          fi

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/articles/cases/index.json public/sitemap.xml
          git commit -m "ü§ñ Auto-update case studies index and sitemap - reveal scheduled content"
          git push
          echo "‚úÖ Index and sitemap updated and pushed to repository"

      - name: No changes message
        if: steps.verify-changed-files.outputs.changed == 'false'
        run: |
          echo "‚ÑπÔ∏è No new case studies to reveal today - index and sitemap unchanged"
