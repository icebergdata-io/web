<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Case Study - Iceberg Data</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/marked@4.3.0/marked.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
            color: #1a202c;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .header {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a202c;
        }
        .subtitle {
            font-size: 1.25rem;
            color: #4a5568;
            margin-bottom: 2rem;
        }
        .content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .section {
            margin-bottom: 2rem;
        }
        .section h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3748;
        }
        .section p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .features ul {
            list-style: disc;
            padding-left: 1.5rem;
        }
        .features li {
            margin-bottom: 0.5rem;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #4a5568;
        }
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const { useState, useEffect, createElement: h } = React;

        function PrivateCaseStudy() {
            const [caseData, setCaseData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // Safe markdown parsing function
            function safeMarkdownParse(text) {
                if (!text || typeof text !== 'string') {
                    return '';
                }
                try {
                    return marked.parse(text);
                } catch (err) {
                    console.warn('Markdown parsing error:', err);
                    return text; // Return plain text if parsing fails
                }
            }

            useEffect(() => {
                // Get caseId and accessToken from URL
                const pathSegments = window.location.pathname.split('/').filter(segment => segment !== '');
                const caseId = pathSegments[1];
                const accessToken = pathSegments[2];

                if (!caseId || !accessToken) {
                    setError('Invalid URL format. Expected: /private-case-study/[caseId]/[accessToken]');
                    setLoading(false);
                    return;
                }

                // Load sharing configuration
                fetch('/private-sharing-config.json')
                    .then(response => response.json())
                    .then(config => {
                        if (!config.sharingEnabled) {
                            throw new Error('Private sharing is disabled');
                        }

                        const tokenData = config.accessTokens[caseId];
                        if (!tokenData || tokenData.token !== accessToken) {
                            throw new Error('Invalid access token');
                        }

                        // Load case study
                        return fetch(`/private-case-studies/${tokenData.filename}`);
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Case study not found');
                        }
                        return response.json();
                    })
                    .then(data => {
                        setCaseData(data);
                    })
                    .catch(err => {
                        console.error('Error loading private case study:', err);
                        setError(err.message);
                    })
                    .finally(() => {
                        setLoading(false);
                    });
            }, []);

            if (loading) {
                return h('div', { className: 'container' },
                    h('div', { className: 'loading' },
                        h('h1', null, 'Loading private case study...')
                    )
                );
            }

            if (error) {
                return h('div', { className: 'container' },
                    h('div', { className: 'header' },
                        h('h1', { className: 'title' }, 'Access Denied'),
                        h('div', { className: 'error' }, error),
                        h('p', null, 'Please ensure you have the correct link and access token.')
                    )
                );
            }

            if (!caseData) {
                return h('div', { className: 'container' },
                    h('div', { className: 'header' },
                        h('h1', { className: 'title' }, 'Case Study Not Found'),
                        h('p', null, 'The private case study you are looking for does not exist.')
                    )
                );
            }

            return h('div', { className: 'container' },
                h('div', { className: 'header' },
                    h('span', { className: 'badge' }, `Private Case Study - ${caseData.Sector}`),
                    h('h1', { className: 'title' }, caseData.Title),
                    h('p', { className: 'subtitle' }, caseData.Subtitle)
                ),
                h('div', { className: 'content' },
                    h('div', { className: 'section' },
                        h('h2', null, 'Client Background'),
                        h('p', null, caseData["Client Background"])
                    ),
                    h('div', { className: 'section' },
                        h('h2', null, 'Challenge'),
                        h('p', null, caseData.Challenge)
                    ),
                    h('div', { className: 'section' },
                        h('h2', null, 'Solution'),
                        h('div', { 
                            dangerouslySetInnerHTML: { __html: safeMarkdownParse(caseData.Solution) }
                        })
                    ),
                    h('div', { className: 'section features' },
                        h('h2', null, 'Key Features'),
                        h('ul', null,
                            caseData["Key Features"] && caseData["Key Features"].map((feature, index) =>
                                h('li', { key: index }, feature)
                            )
                        )
                    ),
                    h('div', { className: 'section' },
                        h('h2', null, 'Business Impact'),
                        h('div', { 
                            dangerouslySetInnerHTML: { __html: safeMarkdownParse(caseData["Business Impact"]) }
                        })
                    ),
                    h('div', { className: 'section' },
                        h('p', null, 
                            h('strong', null, 'Publication Date: '), 
                            caseData.publicationDate
                        )
                    )
                )
            );
        }

        // Use React 18 createRoot API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(PrivateCaseStudy));
    </script>
</body>
</html>
